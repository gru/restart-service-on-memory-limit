# Скрипт мониторинга и перезапуска сервисов

Этот скрипт (`restart-service-on-memory-limit.sh`) проверяет использование памяти сервисами systemd и перезапускает их, если использование памяти превышает заданный порог.

## Настройка запуска по cron

Чтобы настроить автоматический запуск скрипта каждые 5 минут с помощью cron, выполните следующие шаги:

1. Убедитесь, что скрипт имеет права на выполнение:

   ```
   chmod +x /путь/к/вашему/скрипту/restart-service-on-memory-limit.sh
   ```

2. Откройте файл crontab для редактирования:

   ```
   crontab -e
   ```

3. Добавьте следующую строку в конец файла:

   ```
   */5 * * * * /путь/к/вашему/скрипту/restart-service-on-memory-limit.sh
   ```

   Замените `/путь/к/вашему/скрипту/` на фактический путь к скрипту.

4. Сохраните файл и выйдите из редактора.

После этого cron будет автоматически запускать скрипт каждые 5 минут.

## Настройка скрипта

Перед использованием скрипта убедитесь, что вы настроили следующие параметры в `restart-service-on-memory-limit.sh`:

- `SERVICE_PREFIX`: префикс имени сервиса для фильтрации
- `MEMORY_THRESHOLD_PERCENT`: пороговое значение использования памяти в процентах

## Разрешения и права

1. Право на выполнение команды systemctl list-units
2. Право на выполнение команды `systemctl show`
3. Право на выполнение команды `systemctl restart`

Чтобы предоставить эти права без полного доступа root, можно использовать sudo с ограниченным набором команд. Для этого нужно отредактировать файл /etc/sudoers и добавить следующие строки:

```
username ALL=(ALL) NOPASSWD: /bin/systemctl list-units
username ALL=(ALL) NOPASSWD: /bin/systemctl show
username ALL=(ALL) NOPASSWD: /bin/systemctl restart
```

Где username - имя пользователя, которому вы хотите дать эти права.

## Настройка запуска от имени определенного пользователя

Чтобы запускать скрипт от имени определенного пользователя через cron, используйте один из следующих методов:

1. Редактирование системного crontab для конкретного пользователя:

   ```bash
   sudo crontab -e -u username
   ```

   Добавьте строку:
   ```
   */5 * * * * /путь/к/вашему/скрипту/restart-service-on-memory-limit.sh
   ```

2. Использование sudo в crontab записи (в crontab root пользователя):

   ```
   */5 * * * * sudo -u username /путь/к/вашему/скрипту/restart-service-on-memory-limit.sh
   ```

Убедитесь, что у выбранного пользователя есть необходимые права для выполнения команд в скрипте.

## Проверка работы

Рекомендуется проверить работу скрипта вручную перед настройкой автоматического запуска:

1. Скопируйте конфигурационный файл сервиса:
```bash
sudo cp test-memory-service.service /etc/systemd/system/
```

2. Перезагрузите сервисы:
```bash
sudo systemctl daemon-reload
```

3. Запустите сервис:
```bash
sudo systemctl start test-memory-service
```

4. Проверьте статус сервиса:
```bash
sudo systemctl status test-memory-service
```

5. Установите префикс сервиса:
```bash
SERVICE_PREFIX="test-memory"
```

6. Запустите скрипт для проверки:
```bash
sudo ./restart-service-on-memory-limit.sh
```

